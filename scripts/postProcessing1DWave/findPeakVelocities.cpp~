

#include <iostream>
#include <iomanip>
#include <fstream>
#include <string>
#include <sstream>
#include <stdlib.h>
#include <string.h>
#include <vector>
#include <math.h>


using namespace std;

int main (){
  
  const int n_col=8;// number of columns in simulation output file
  double buffer;
  double timeInterval;
  int counter=0;
  vector<double> row(n_col,0);
  vector <vector <double> > MaxVelocAllInstants;// vector for max velocities of all instants and their corresponding time value
  vector <double>maxVelThisInstAndTime(2,0);
  int fileCounter=0;
  
  cout<<"please enter the output time interval in s (as precised in 1DWave.tcl file:"<<endl;
  cin>>timeInterval;
  // while loop over all output intervall values
  for(;;) {
    double maxVelocThisInstant=0;// max velocity of current instant(=output time)
    
    // assemble input file name
    stringstream number;//string for number (time stamp)
    stringstream number2;//string for second time stamp if first one not o.k.
    // calculate number (time stamp) for file name
    // needs to be casted to int as otherwise numbers over1.have the format 1e+6 
    number << setw(8) << setfill('0') <<(int)(fileCounter*timeInterval*1000000);
    const string inputfile = "../../src/outdata/prtl" + number.str() + ".dat";
    cout<<endl<<inputfile<<endl;

    // create and open inputfile
    ifstream fin(inputfile.c_str(), ios::in);
    // test if inputfile opened, if not try different filename
    if (!fin) {
      // this is as sometimes filenames are...999 instead of ..0000
      // because time value is truncated for timestamp of file name...
      number2 << setw(8) << setfill('0') <<(int)(fileCounter*timeInterval*1000000-1);
      const string inputfile2 = "../../src/outdata/prtl" + number2.str() + ".dat";
      cout<<endl<<inputfile2<<endl;
      // assign a new filename to the streaming object
      fin.open(inputfile2.c_str(), ifstream::in);
      if(!fin) {
	cout<<"no (more)file could be found: either all files have already been processed"<<endl;
	cout<<"or there is a problem with the file name"<<endl;
	cout<<"to chech if all files have already been treated, here the number of files that are read by the program: "<<fileCounter<<endl;
	break;
      }
    }     
    // while reading directly sort out the boundary particles
    while(!fin.eof()) {
      
      // very "elegant" way of cutting off first to lines of file 
      // (as they do not contain data), but did not know any better
      string garbage;
      getline(fin,garbage);
      getline(fin,garbage);
      
      for (int i=0; i<n_col&&!fin.eof();i++) {
	// problem: reads always one more than eof
	fin>>buffer;
	row[i]=buffer; 
      }
      // to be sure the last row (which is already eof and does
      // not correspond to a physical row of the file any more)
      // is not added make ID=0;
      if(fin.eof()) {
	row[6]=0;
      }
      // determine max velocity for this instant if
      // -the row does not correspond to a boundary particle
      // (for which ID=0) add it to the matrix vector
      // - and if x is <0.5 (to only tread LHS of the domain, as there would be another
      // maximum at period/2 on the RHS of the domain
      
      if(row[n_col-2]!=0&&row[0]<0.5) {
	// probably not needed

	if (row[4]>maxVelocThisInstant)
	  maxVelocThisInstant=row[4];
      }
    } 
      
    fin.close();// close inputfile
    // pair maximum velocity of this instant with corresponding time:
    maxVelThisInstAndTime[0]=maxVelocThisInstant;
    maxVelThisInstAndTime[1]=fileCounter*timeInterval;
    //put max velocity this instant in an array/vector
    MaxVelocAllInstants.push_back(maxVelThisInstAndTime);
    //increment file counter as loop will restart for next input file
    fileCounter++;  
  }
  // end while loop over all files
  
  // now find the local maxima in the  MaxVelocAllInstants vector as they are the 
  // needed peak velocity values for each period
  vector <vector <double> >PeakVelocEachPeriod;
  // first entry is a maximum (known, as initialization is done that way)
  PeakVelocEachPeriod.push_back(MaxVelocAllInstants[0]);
  // now iterate all aoterh entries and try to find local maxima
  for(int i=0;i< MaxVelocAllInstants.size()-2;i++) {
    if(MaxVelocAllInstants[i][0]<MaxVelocAllInstants[i+1][0]
       &&MaxVelocAllInstants[i+2][0]<MaxVelocAllInstants[i+1][0])
      PeakVelocEachPeriod.push_back(MaxVelocAllInstants[i+1]);
  }
  
  const string outputfile = "../../results/ResultsInProgress/peakVelocities.dat";
  // create and open outputfile
  ofstream out(outputfile.c_str());
  
  // test if file opened
  if (!out){
    cout<<"Cannot create file "<<outputfile<<"\n" ;
    exit(1);
  }
  else cout<<"\n writing in file\n"; 
  // write file header
  out<<"peak velocity for each period and corresponding time\n";
  out<<"format: period number | peak velocity | time \n";
  // write data into file
  for(int i=0;i<PeakVelocEachPeriod.size();i++) {
    out<<setprecision(9)
       << ::setw(17)<<i+1 // period number (starting at 1)
       << ::setw(17)<<PeakVelocEachPeriod[i][0] // peak velocity
       << ::setw(17)<<PeakVelocEachPeriod[i][1] // corresponding time       
       <<"\n";
  }
  out.close();// close output file
  cout<<"\n 1D Wave port-processing date written to:\n";
  cout<<"   "<<outputfile<<"\n";
  
  cout<<"\n program ended\n";
  return 0;
}
